<html>

<head>
  <meta charset="UTF-8">
  <title>Table with Sortable Columns</title>
  <link href="../../../resources/static/styles.css" rel="stylesheet" media="screen" th:href="@{styles.css}" />
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

</head>

<body>
  <header th:replace="fragments/header :: header" />

  <label for="fCypher">Cypher</label>
  <textarea id="fCypher" name="fCypher"></textarea>
  <button type="submit" id="submitButton" name="submitButton">Submit</button>
  <br/>
  <label for="fSearch">Search</label>
  <input type="text" id="fSearch" name="fSearch">
  
  <div id="example-table" ></div>

  <script>
    // https://tabulator.info/docs/5.5/options
    
    var cypherQuery = 'MATCH (n:Person) RETURN n.fullName, n.birthday, n.dotId';

    var table = new Tabulator("#example-table", {
      // data: arrayData,
      importFormat: "array",
      height: "90vh",
      layout: "fitColumns",
      autoColumns: true,
    });

    function getDataFromEndpoint(cypherQuery) {
      const queryParams = new URLSearchParams({ cypherQuery: cypherQuery });
      const url = `http://localhost:8080/execCypherAndGetString?${queryParams}`;

      return fetch(url)
        .then(response => response.text())
        .then(response => {
          const rows = response.trim().split('\n');
          const arrayData = rows.map(row => row.split('\t'));

          // tabulator doesn't like dots in column names:
          arrayData[0].forEach((header, index) => {
            arrayData[0][index] = header.replace('.', 'â€¢');
          });
          console.log(arrayData.length);
          return arrayData;
        });
    }
    getDataFromEndpoint(cypherQuery).then(arrayData => {
      console.log("we got size:" + arrayData.length);
      table.setData(arrayData);
    });
    

    
    function matchAny(data, filterParams) {
      //data - the data for the row being filtered
      //filterParams - params object passed to the filter
      //RegExp - modifier "i" - case insensitve

      var match = false;
      const regex = RegExp(filterParams.value, 'i');

      for (var key in data) {
        if (regex.test(data[key]) == true) {
          match = true;
        }
      }
      return match;
    }
    const input = document.getElementById("fSearch");
    input.addEventListener("keyup", function () {
      table.setFilter(matchAny, { value: input.value });
      if (input.value == " ") {
        table.clearFilter()
      }
    });

    
    const submitButton = document.getElementById('submitButton');
    const fCypherInput = document.getElementById('fCypher');
    fCypherInput.value = cypherQuery;
    
    submitButton.addEventListener('click', () => {
      cypherQuery = fCypherInput.value;
      getDataFromEndpoint(cypherQuery).then(arrayData => {
        table.setData(arrayData);
      });
      
    });

  </script>
</body>

</html>